Baseline: 2025-09-15 (petscii-good-baseline)
-------------------------------------------

Goal
- Render PETSCIIU/PETSCIIL art faithfully in xterm.js with correct colors, inverse, glyphs, and line control.

Pin
- Git commit: b0d1475 on branch petscii-good-baseline
- xterm.js: 5.3.0 (via CDN in static/index.html)
- Tested in: Chromium/Chrome recent (ensure Unifont OTF loads)

Key Behaviors (Working)
- PETSCII/ATASCII control handling:
  - Translate legacy controls to ANSI first (cursor, clear, reverse, colors).
  - After translation, normalize:
    - ESC[…M → ESC[…m (SGR; only when params are digits/semicolons)
    - ESC[…j → ESC[…J (clear sequences; only when params are digits/semicolons)
- PETSCII special cases:
  - 0x0F (SI) ignored (no replacement glyph in output).
  - CR (0x0D) outputs CRLF when not followed by LF to advance lines in xterm.js.
  - Multiple consecutive CRs collapsed to single CRLF (prevents extra blank lines).
  - 0x14 (DELETE) implemented as destructive backspace (backspace-space-backspace).
  - 0x07 (BELL) and 0x09 (TAB) pass through as ASCII.
- Fonts:
  - Use local Unifont OTFs for PETSCII glyphs (U+1FB00–1FBFF). Removed broken .woff2 references.
- Debugging:
  - HEX_DUMP logs include "TEXT (final)" — the exact bytes sent to the browser.
  - Enhanced capture system saves timestamped files with metadata.

What We Avoid On Purpose
- No pre-normalization of raw bytes. We do not treat PETSCII 0x9B as ANSI.
- No ANSI join/glue buffering right now; we rely on xterm.js streaming behavior and our post-translation normalizer.

Environment Flags (typical run)
- HEX_DUMP=true — observe stream and “TEXT (final) …”.
- ANSI_DEBUG=false — optional extra logs from enhanced ANSI processor.

Do / Don't
- Do: Normalize SGR case (…M→m, …j→J) only after PETSCII/ATASCII control translation.
- Do: Treat PETSCII 0x0F (SI) as no-op; map lone CR to CRLF for line advance.
- Don’t: Pre-normalize raw bytes; don’t treat 0x9B as CSI in legacy paths.
- Don’t: Add streaming joiners unless we see CSI fragments printing in TEXT (final).

Results
- DEAD ZONE login art and “Press Delete!” screen render close to SyncTERM output.
- Line erase/delete behaviors fixed by SGR normalization (…M→m).

Caveats / Watchouts
- If any CSI prints as plain text, check for chunk-splitting edge cases (rare). We’ll add a small streaming joiner only if needed.
- Some boards send ESC[2j; we normalize to ESC[2J post-translation for better compatibility.

Golden Sample (reference)
- Example “TEXT (final)” should show lowercase ‘m’ in SGR and ‘J’ in clears, e.g.:
  - "\x1b[37m...\x1b[27m" (SGR reset/inverse off)
  - "\x1b[2J\x1b[H" (clear + home)
- When inspecting logs, search for uppercase 'M' in SGR; none should appear post-normalization.

